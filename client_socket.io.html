<!DOCTYPE html>
<html lang="fr">
   <head>
      <script src="/socket.io/socket.io.js"></script>
      <script src="https://d3js.org/d3.v7.min.js"></script>
      <script>
         var socket = io();
         var Myname ="";
         var MyNum = -1;
         var P1 = [255,0,0] //r,g,b
         var P2 = [0,0,255] //r,g,b

         function componentToHex(c) {
            var hex = c.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
         }

         function rgbToHex(r, g, b) {
            return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
         }

         function hexToRgb(hex) {
            var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
               r: parseInt(result[1], 16),
               g: parseInt(result[2], 16),
               b: parseInt(result[3], 16)
            } : null;
         }

         function test() { //                                                 TEST COMMUNICATION SERVEUR
            console.log("Appel du serveur");
            socket.emit('test', "Ô serveur je t'envoie ce message");
         }

         socket.on('test', data => {  //                                      RECUPERATION DU TEST DE COMMUNICATION SERVEUR
            console.log('Réponse du serveur :');
            console.dir(data);
            socket.emit('demandeH')
         });

         function player_in(){
            var TextInput = document.getElementById("text_input")
            var Playerinfo = document.getElementById("Player_name")
            TextInput.value="";
            document.getElementById("start").setAttribute("disabled","")
            document.getElementById("exit").removeAttribute("disabled","")
            TextInput.setAttribute("readonly","")
            Playerinfo.innerText=Myname;
            socket.emit('numplayer',Myname)
         }

         function player_out(){
            var TextInput = document.getElementById("text_input")
            var Playerinfo = document.getElementById("Player_name")
            document.getElementById("information").innerText=""
            document.getElementById("start").removeAttribute("disabled")
            document.getElementById("exit").setAttribute("disabled","")
            TextInput.removeAttribute("readonly")
            TextInput.setAttribute("placeholder","Your fucking Name")
            Playerinfo.innerText="none";
            socket.emit('numplayer',Myname)
         }

         function modif_text_box(){  //                                       FONCTION D'ENTREE DANS LE SERVEUR
            var TextInput = document.getElementById("text_input")
            var Info = document.getElementById("information")
            if (TextInput.value==""){
               Info.innerText="Veuillez saisir une entrée ! Aucune entrée saisie !"
               TextInput.setAttribute("placeholder","Veuillez entrée un nom")
            }else{
               Info.innerText=""
               console.log("Envoie d'une demande de changment de test")
               socket.emit('enter',(TextInput.value))
               player_in();
               console.log(TextInput.value)
               
            }
         }

         function exit(){  //                                                    FONCTION DE SORTIE DE LA PARTIE
            console.log(Myname);
            if (Myname!=""){
               socket.emit('exit',Myname);
               Myname=""
               player_out();
            }else{
               document.getElementById("information").innerText="Personne à faire sortir !"
            }
         }

         socket.on('enter',data => {  //                                         RECUPERATION DE LA LISTE DES JOUEURS
            console.log('J\'ai reçu ma zone de texte !')
            const MyText = document.getElementById("text-box_test")
            MyText.innerText=data
            MyName=data
         })

         var affichetimer=null;

         function afficheInfo(info){
            if (affichetimer){
               clearTimeout(affichetimer);
            }
            var Info = document.getElementById("information");
            Info.innerText = info;
            affichetimer = setTimeout(function(){
               Info.innerText = "";
            }, 5000)
         }

         socket.on('information',data => {   //                                  RECUPERATION D'INFORMATION SERVEUR
            if (data=="free"){
               if (Myname==""){
                  afficheInfo("Une personne vient de sortir.");
                  player_out();
               }
            }
            else if (data=="full"){
               afficheInfo("Partie pleine !");
               document.getElementById("exit").setAttribute("disabled","")
               document.getElementById("start").setAttribute("disabled","")
               document.getElementById("text_input").setAttribute("readonly","")
            }
            else if (data=="starting"){
               afficheInfo("La partie commence dans 5 Sec...");
            }
            else if (data=="started"){
               afficheInfo("La partie commence!");

            }
            else if (data=="cancel"){
               afficheInfo("Annulation car un joueur a quitté la partie!");
            }
         })
         
         socket.on('numplayer',data => {  //                                         RECUPERATION DU NUMERO DU JOUEUR
            MyNum=data
         })

         function envoiMessage(text_content){ //                                  ENVOIE DE MESSAGE
            if (Myname==""){
               console.log("Pas de nom de joueurs")
            }else{
               socket.emit('message',[text_content.value,Myname]);
               //messages.value += text_content.value+"\n";
               console.log("Je m'appelle :"+Myname)
               text_content.value=""
            }
         }
         socket.on('message',data => { //                                        ACTUALISATION DU CHAT
            tmp = data + messages.value;
            messages.value = tmp
         })
         socket.on('NewName',data => { //                                        MODIFICATION DU NOM CAR DEJA EXISTANT
                  Myname=data;
                  document.getElementById("text_input").setAttribute("placeholder","Your name is : "+Myname);
         })
         
         socket.on('action', data => {
            NumPlay=data[0]
            NumHex=data[1]
            MyHexa=d3.select(document.getElementById("h"+NumHex))
            console.log("Hexagone reçu : " + "h"+NumHex)
            if (NumPlay==0){   
               MyHexa.attr('fill',"rgb("+P1[0]+","+P1[1]+","+P1[2]+")");
            }else if (NumPlay==1){
               MyHexa.attr('fill',"rgb("+P2[0]+","+P2[1]+","+P2[2]+")");
            }
         })

         socket.on('demandeH',data => {
            T=data.length
            i=0
            console.log("Historique reçu")
            while(i<T){
               NumPlay=data[i][0]
               NumHex=data[i][1]
               MyHexa=d3.select(document.getElementById("h"+NumHex))
               if (NumPlay==0){
                  MyHexa.attr('fill',"rgb("+P1[0]+","+P1[1]+","+P1[2]+")");
               }else if (NumPlay==1){
                  MyHexa.attr('fill',"rgb("+P2[0]+","+P2[1]+","+P2[2]+")");
               }
               i++
            }
         })



// =======================================================================================================================================================
// TABLIER
// =======================================================================================================================================================

         function creeHexagone(rayon) {
            var points = new Array();
            for (var i = 0; i < 6; ++i) {
            var angle = i * Math.PI / 3;
            var x = Math.sin(angle) * rayon;
            var y = -Math.cos(angle) * rayon;
	         console.log("x="+Math.round(x*100)/100+" y="+Math.round(y*100)/100);
            points.push([Math.round(x*100)/100, Math.round(y*100)/100]);
            }
            return points;
         }

         function genereDamier(rayon, nbLignes, nbColonnes) {

            distance =  rayon - (Math.sin(1 * Math.PI / 3) * rayon);  // plus grande distance entre l'hexagone et le cercle circonscrit

            d3.select("#tablier").append("svg").attr("width", "1000").attr("height", "1000");
            var hexagone = creeHexagone(rayon);
            for (var ligne=0; ligne < nbLignes; ligne++) {
               for (var colonne=0; colonne < nbColonnes; colonne++) {
                  var d = "M";
                  var x, y;
                  for (h in hexagone) {
                     x = hexagone[h][0]+(rayon-distance)*(2+2*colonne)+((nbLignes-ligne)*(rayon-distance));
                     y = distance*2 + hexagone[h][1]+(rayon-distance*2)*(1+2*ligne);
                     d += x+","+y+" "
                  }
                  d += "Z";
                  console.log(d)
                  d3.select("svg")
                  .append("path")
                  .attr("d",d)
                  .attr("stroke","black")
                  .attr("fill","white")
                  .attr("id", "h"+(ligne*11+colonne)) // car un id doit commencer par une lettre
                  .on("click", function(d) {
                     let numHexagone = parseInt(d3.select(this)
                     .attr('id')
                     .substring(1))
                     mafonction(d3.select(this))
                     console.log("Hexagone cliqué : "+ numHexagone)
                     console.log(d3.select(this).attr('id'));
                     //d3.select(this).attr('fill', 'red');
                  });
               }
            }
         }

         function mafonction(h){
            var Info = document.getElementById("information")
            var numHexagone = parseInt(h.attr('id').substring(1))
            console.log(numHexagone)
            if (Myname==""){
               Info.innerText="Tu n'es pas joueur !"
            }else{
               Info.innerText=""
               socket.emit('action',[Myname,numHexagone])
            }
         }

// =======================================================================================================================================================

         window.addEventListener('load', () => { test(); genereDamier(30,11,11) } );
         window.addEventListener("load", color, false);

         function color() {
            var Player1 = document.getElementById("P1color");
            var Player2 = document.getElementById("P2color");
            var P1def = rgbToHex(P1[0],P1[1],P1[2]);
            var P2def = rgbToHex(P2[0],P2[1],P2[2]);
            Player1.value = P1def
            Player2.value = P2def
            Player1.addEventListener("change", updateAll, false);
            Player2.addEventListener("change", updateAll, false);

         }

         function updateAll(event) {
            elem=document.getElementById(event.target.id)
            newrgb=hexToRgb(elem.value)
            console.log(newrgb)
            if (event.target.id=="P1color"){
               P1[0]=newrgb.r
               P1[1]=newrgb.g
               P1[2]=newrgb.b
            }else if (event.target.id=="P2color"){
               P2[0]=newrgb.r
               P2[1]=newrgb.g
               P2[2]=newrgb.b
            }
            console.log(P1)
            console.log(P2)
            socket.emit('demandeH',"")
         }


      </script>
      <title>Jeu de HEX</title>
   </head>
   <body style="background-color: gray;;"> 
      <h1 style="text-align: center;">Bienvenue dans le jeu de HEX</h1>
      <div name="entry" id="entry">
         <input type="text" id="text_input" name="text_input" maxlength="20" placeholder="Your Fucking name !" required min="1" onChange="modif_text_box()" autofocus>
         <button type="button" name="start" id="start" style="background-color: black;color: white; display: inline-block;">
            Enter
         </button>
         <button type="button" name="exit" id="exit" style="background-color: black;color: white; display: inline-block;" disabled>
            Exit
         </button>
         <p style="color: red;display: inline-block;" name="information" id="information"></p>
      </div>
      <div name="log" id="log">
         <p style="display: inline-block;">Joueurs : </p> <p name="text-box_test" id="text-box_test" readonly style="display: inline-block;"></p>
      </div>
      <div>
         <div id="tablier" style="float:left;" />
         <div style="float:right;">
         <input id="message" type="text" onChange="envoiMessage(this)" placeholder="Votre message" value=""/><br/>
         <textarea id="messages" rows="30" cols="25" style="resize: none;" readonly></textarea>
         </div>
      </div>
      <div name="menu" id="menu" style="height: auto; border: 2px solid black; padding: 30px;margin: 30px; background-color:lightgray;display: inline-block; text-align:left;align-items: center;">
         Votre nom : <p id="Player_name" style="display: inline-block;"> none</p>
         <br>
         Spectateur <input type="checkbox" id="spectator"></input>
         <br>
         <label for="P1color">Couleur Player 1 :</label>
         <input type="color" id="P1color"></input>
         <br>
         <label for="P2color">Couleur Player 2 :</label>
         <input type="color" id="P2color"></input>
      </div>
   </body>
   <script>
   document.getElementById("start").addEventListener("click",() => { modif_text_box(); })
   document.getElementById("exit").addEventListener("click",() => { exit(); })
   </script>
</html>